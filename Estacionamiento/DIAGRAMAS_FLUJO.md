# ğŸ”„ DIAGRAMA DE FLUJO DEL SISTEMA

## 1. FLUJO PRINCIPAL (Loop)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          SISTEMA INICIADO              â”‚
â”‚      "Sistema Listo / Esperando..."     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  checkRFID()       â”‚  â† Intenta leer tarjeta
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ NO TARJETA â”€â”€â†’ [Esperar]
             â”‚
             â””â”€ TARJETA DETECTADA â”€â”€â†’ [Validar]
                                      â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                           â”‚
                        â–¼                           â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  AUTORIZADO âœ…  â”‚      â”‚  NO AUTORIZADO âŒâ”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                        â”‚
                         â–¼                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚"Bienvenido!"        â”‚   â”‚"ACCESO DENEGADO"   â”‚
            â”‚Buzzer: 3 beeps      â”‚   â”‚Buzzer: 2 beeps     â”‚
            â”‚Servo levanta (0Â°)   â”‚   â”‚Espera 3 segundos   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                         â”‚
                     â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚Espera UltrasÃ³nico    â”‚   â”‚ Vuelve a estado  â”‚
         â”‚(distancia > 30cm)    â”‚   â”‚ "Sistema Listo"  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         Nota: Antes de conceder acceso se verifica la disponibilidad.
         Si no hay cajones disponibles â†’ Mostrar "LLENO" y denegar acceso.
                  â”‚
                  â”œâ”€ COCHE PASA â”€â”€â†’ Servo baja (180Â°)
                  â”‚                 Display: "Pase seguro"
                  â”‚
                  â””â”€ TIMEOUT â”€â”€â”€â”€â†’ Servo baja igualmente
                                  (seguridad)
                                  â”‚
                                  â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ Vuelve a estado  â”‚
                           â”‚ "Sistema Listo"  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. FLUJO DE ESTACIONAMIENTO

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   checkParkingSlots â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
              â–¼              â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Slot 1   â”‚  â”‚ Slot 2   â”‚  â”‚ Slot 3,4 â”‚
        â”‚ GPIO 13  â”‚  â”‚ GPIO 12  â”‚  â”‚ similar  â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚             â”‚             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                             â”‚
    â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Presionado  â”‚                          â”‚   Soltado    â”‚
â”‚ (LOW)       â”‚                          â”‚   (HIGH)     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                          â”‚
  [SI]                                       [SI]
     â”‚                                          â”‚
     â–¼                                          â–¼
Cambio de estado                        Cambio de estado
Ocupado â† Disponible                    Disponible â† Ocupado
     â”‚                                          â”‚
     â–¼                                          â–¼
LED ROJO ON                            LED ROJO OFF
(GPIO 21/22/23/25)                     (GPIO 21/22/23/25)
     â”‚                                          â”‚
     â–¼                                          â–¼
Serial.print("CajÃ³n X - OCUPADO")      Serial.print("CajÃ³n X - DISPONIBLE")

Nota: Al cambiar a OCUPADO se decrementa el contador de disponibilidad.
Al cambiar a DISPONIBLE se incrementa y se lanza la secuencia de salida
(levantar pluma -> esperar 3s -> bajar pluma) para permitir la salida.
```

---

## 3. MÃQUINA DE ESTADOS - CASETA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ESPERANDO TARJETA  â”‚  â† Estado inicial
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
        [RFID]
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VALIDANDO TARJETA    â”‚
â”‚ - Lectura UID        â”‚
â”‚ - BÃºsqueda en BD     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
     â”‚            â”‚
  [âœ…]          [âŒ]
     â”‚            â”‚
     â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚AUTORIZADOâ”‚  â”‚DENEGADO   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚
     â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚LEVANTANDOâ”‚  â”‚MOSTRANDO  â”‚
â”‚ BARRA   â”‚  â”‚ RECHAZO   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚
     â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ESPERANDO â”‚  â”‚ ESPERA 3s â”‚
â”‚ULTRASÃ“NICO                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚
  [PASE]            â”‚
     â”‚              â”‚
     â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚BAJANDO   â”‚  â”‚ESPERANDO     â”‚
â”‚BARRA    â”‚  â”‚TARJETA NUEVA â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚LISTA PARA   â”‚
     â”‚PRÃ“XIMA      â”‚
     â”‚LECTURA      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. DIAGRAMA DE SENSORES

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RFID RC522     â”‚ (Entrada)
â”‚  - UID del      â”‚
â”‚    usuario      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ VÃ¡lido? â”‚
    â””â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”˜
       â”‚  â”‚
    SÃ­ â”‚  â”‚ No
       â–¼  â–¼
    âœ…   âŒ
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ULTRASÃ“NICO HC-SR04â”‚ (Distancia)
â”‚ - Mide 100ms       â”‚
â”‚ - Si > 30cm        â”‚
â”‚   â†’ Coche pasÃ³     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ > 30cm? â”‚
    â””â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”˜
       â”‚  â”‚
    SÃ­ â”‚  â”‚ No
       â–¼  â–¼
    BAJA CONTINÃšA
    BARRA ARRIBA
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SWITCHES (4)    â”‚ (Manual)
â”‚ - GPIO 13,12,   â”‚
â”‚   14,26         â”‚
â”‚ - LOW = ocupado â”‚
â”‚ - HIGH = libre  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Cambio? â”‚
    â””â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”˜
       â”‚  â”‚
    SÃ­ â”‚  â”‚ No
       â–¼  â–¼
    LED  MANTENER
    ON/OFF ESTADO
```

---

## 5. ECUACIONES CRÃTICAS

### Distancia UltrasÃ³nica
```
Distancia (cm) = Tiempo_pulso (Âµs) Ã— 0.0343 Ã· 2

Si mide el doble â†’ Cambiar 0.0343 a 0.0172
Si mide la mitad â†’ Cambiar 0.0343 a 0.0686

CalibraciÃ³n simple:
1. Coloca objeto a 10cm
2. Lee valor en Serial Monitor
3. Si lee 20cm â†’ Usa 0.0172
4. Si lee 5cm  â†’ Usa 0.0686
```

### Ãngulos Servo
```
0Â° = Barra LEVANTADA (abierta)
180Â° = Barra BAJADA (cerrada)

Si tu servo es diferente:
- Prueba: 90Â° = media barra
- Ajusta en config.h:
  #define SERVO_ANGLE_UP 0
  #define SERVO_ANGLE_DOWN 180
```

### DetecciÃ³n de Cambio (Switches)
```
digitalRead(SWITCH_SLOT1) == LOW  â†’ Presionado (OCUPADO)
digitalRead(SWITCH_SLOT1) == HIGH â†’ Soltado (DISPONIBLE)

Cambio detectado cuando:
- Estado anterior â‰  Estado actual
- Se enciende/apaga LED
- Se imprime en Serial
```

---

## 6. TIEMPOS CRÃTICOS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RFID_COOLDOWN                   â”‚ 2000ms
â”‚ (Evita mÃºltiples lecturas)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ULTRASONIC_CHECK_INTERVAL       â”‚ 100ms
â”‚ (Frecuencia de mediciÃ³n)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVO_TRANSITION_TIME           â”‚ 500ms
â”‚ (Tiempo de levante/bajada)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BARRIER_TIMEOUT                 â”‚ 5000ms
â”‚ (MÃ¡x tiempo con barra arriba)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WELCOME_BEEP_DURATION           â”‚ 200ms
â”‚ (DuraciÃ³n de cada beep)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DENIED_BEEP_DURATION            â”‚ 500ms
â”‚ (Beep de rechazo mÃ¡s largo)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Serial Loop Interval            â”‚ 50ms
â”‚ (Velocidad del loop principal)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. FLUJO DE ENERGÃA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fuente 5V, 3A    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚          â”‚
    â–¼          â–¼
  +5V        GND
    â”‚          â”‚
    â”œâ”€â†’ RFID   â”‚
    â”œâ”€â†’ Servo  â”‚
    â”œâ”€â†’ LCD    â”‚
    â”œâ”€â†’ LEDs   â”‚
    â”œâ”€â†’ Buzzer â”‚
    â””â”€â†’ Ultra. â”‚
               â”‚
    ESP32 â”€â”€â”€â”€â”˜
    (3.3V interno)
```

---

## 8. DECISIONES DEL ALGORITMO

```
Â¿TARJETA RFID PRESENTE?
â”œâ”€ NO â†’ [Esperar]
â””â”€ SÃ â†’ Â¿UID AUTORIZADO?
        â”œâ”€ NO â†’ [Rechazo: 2 beeps, "DENEGADO"]
        â””â”€ SÃ â†’ [Acceso: 3 beeps, "Bienvenido"]
                 â”‚
                 â”œâ†’ Levanta barra (0Â°)
                 â”œâ†’ Espera ultrasÃ³nico
                 â”‚
                 â”œâ”€ Â¿OBJETO A >30cm?
                 â”‚  â”œâ”€ SÃ â†’ [Baja barra, "Pase"]
                 â”‚  â””â”€ NO â†’ [Espera o Timeout]
                 â”‚
                 â””â”€ Â¿TIMEOUT 5s?
                    â”œâ”€ SÃ â†’ [Baja barra por seguridad]
                    â””â”€ NO â†’ [ContinÃºa esperando]

Â¿SWITCH PRESIONADO?
â”œâ”€ NO â†’ [Mantener estado actual]
â””â”€ SÃ â†’ Â¿CAMBIÃ“ ESTADO?
        â”œâ”€ NO â†’ [No hacer nada]
        â””â”€ SÃ â†’ [Cambiar estado LED + Serial]
```

---

Este diagrama te ayudarÃ¡ a entender cada parte del sistema. Todos los tiempos y condiciones estÃ¡n optimizados para operaciÃ³n estable y segura.
